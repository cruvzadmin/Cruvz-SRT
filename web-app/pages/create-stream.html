<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Streaming Service - Cruvz Streaming Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 15px;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0,0,0,0.10);
            border: none;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.97);
        }
        .card-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 16px 16px 0 0 !important;
            padding: 28px 20px 18px 20px;
            text-align: center;
        }
        .status-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.04);
            padding: 18px 0 14px 0;
            margin-bottom: 20px;
            min-height: 120px;
            transition: box-shadow 0.2s;
        }
        .status-card .fa-2x {
            margin-bottom: 10px;
        }
        .protocol-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.22s;
            margin-bottom: 0;
            background: #f3f6fb;
        }
        .protocol-card.selected, .protocol-card:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #e3eafe 0%, #e0f7fa 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .form-label {
            font-weight: 500;
        }
        .form-check-label {
            font-size: 1rem;
            font-weight: 400;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 24px;
            font-size: 1.2rem;
            padding: 12px 0;
            transition: background 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }
        .btn-primary:active, .btn-primary:focus, .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        .alert {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-lg border-0 mb-4">
            <div class="card-header">
              <h2><i class="fas fa-broadcast-tower me-2"></i>Create Professional Streaming Service</h2>
              <p class="mb-0">Deploy production-ready streaming for 1000+ concurrent viewers</p>
            </div>
            <div class="card-body">
              <!-- System Status Row -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <div class="status-card text-center">
                    <i class="fas fa-database fa-2x text-success"></i>
                    <h6 class="mt-2 mb-1">PostgreSQL</h6>
                    <span id="db-status" class="badge bg-secondary">Checking...</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="status-card text-center">
                    <i class="fas fa-bolt fa-2x text-warning"></i>
                    <h6 class="mt-2 mb-1">Redis Cache</h6>
                    <span id="redis-status" class="badge bg-secondary">Checking...</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="status-card text-center">
                    <i class="fas fa-users fa-2x text-info"></i>
                    <h6 class="mt-2 mb-1">Capacity</h6>
                    <span class="badge bg-info text-dark">1000+ Users</span>
                  </div>
                </div>
              </div>
              <!-- Feedback -->
              <div id="feedback" style="display:none"></div>
              <!-- Stream Form -->
              <form id="streamForm" autocomplete="off">
                <div class="mb-3">
                  <label for="streamTitle" class="form-label">Stream Title</label>
                  <input type="text" class="form-control" id="streamTitle" name="title" required maxlength="200" placeholder="Give your stream a catchy name">
                </div>
                <div class="mb-3">
                  <label for="streamDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="streamDescription" name="description" rows="2" maxlength="500" placeholder="Describe your stream..."></textarea>
                </div>
                <div class="mb-3">
                  <label for="maxViewers" class="form-label">Maximum Concurrent Viewers</label>
                  <select class="form-select" id="maxViewers" name="maxViewers">
                    <option value="1000">1,000 viewers</option>
                    <option value="5000">5,000 viewers</option>
                    <option value="10000">10,000 viewers</option>
                  </select>
                </div>
                <!-- Protocol Selection -->
                <div class="mb-4">
                  <label class="form-label">Streaming Protocol</label>
                  <div class="d-flex gap-3 flex-wrap">
                    <div class="protocol-card flex-fill" data-protocol="rtmp">
                      <strong>RTMP</strong><br>
                      <small>For OBS, XSplit</small>
                    </div>
                    <div class="protocol-card flex-fill" data-protocol="srt">
                      <strong>SRT</strong><br>
                      <small>Low latency, error correction</small>
                    </div>
                    <div class="protocol-card flex-fill" data-protocol="webrtc">
                      <strong>WebRTC</strong><br>
                      <small>Ultra low latency</small>
                    </div>
                  </div>
                  <input type="hidden" id="protocol" name="protocol" value="rtmp">
                </div>
                <!-- Quality Settings -->
                <div class="row mb-3">
                  <div class="col">
                    <label for="resolution" class="form-label">Resolution</label>
                    <select class="form-select" id="resolution" name="quality">
                      <option value="1080p">Full HD 1080p</option>
                      <option value="720p">HD 720p</option>
                      <option value="480p">SD 480p</option>
                    </select>
                  </div>
                  <div class="col">
                    <label for="bitrate" class="form-label">Video Bitrate (kbps)</label>
                    <input type="number" class="form-control" id="bitrate" name="bitrate" value="5000" min="500" max="12000">
                  </div>
                  <div class="col">
                    <label for="frameRate" class="form-label">Frame Rate</label>
                    <select class="form-select" id="frameRate" name="frameRate">
                      <option value="30">30 FPS</option>
                      <option value="60">60 FPS</option>
                    </select>
                  </div>
                </div>
                <!-- Features -->
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="enableRecording" name="isRecording">
                  <label class="form-check-label" for="enableRecording">Enable Recording</label>
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="adaptiveBitrate" name="adaptive" checked>
                  <label class="form-check-label" for="adaptiveBitrate">Adaptive Bitrate</label>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                  <span id="submitBtnText">Create Streaming Service</span>
                  <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Protocol selection logic
      document.querySelectorAll('.protocol-card').forEach(card => {
        card.addEventListener('click', function() {
          document.querySelectorAll('.protocol-card').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('protocol').value = this.dataset.protocol;
        });
      });
      // Default RTMP selected
      document.querySelector('[data-protocol="rtmp"]').classList.add('selected');

      // System status polling
      async function checkSystemStatus() {
        try {
          const response = await fetch('/health');
          if (!response.ok) throw new Error('Health check failed');
          const health = await response.json();
          // The backend should return string values: 'connected'/'disconnected'
          document.getElementById('db-status').textContent = health.services?.database === 'connected' ? 'Connected' : 'Disconnected';
          document.getElementById('db-status').className = 'badge ' + (health.services?.database === 'connected' ? 'bg-success' : 'bg-danger');
          document.getElementById('redis-status').textContent = health.services?.cache === 'connected' ? 'Connected' : 'Disconnected';
          document.getElementById('redis-status').className = 'badge ' + (health.services?.cache === 'connected' ? 'bg-success' : 'bg-danger');
        } catch (error) {
          document.getElementById('db-status').textContent = 'Error';
          document.getElementById('db-status').className = 'badge bg-danger';
          document.getElementById('redis-status').textContent = 'Error';
          document.getElementById('redis-status').className = 'badge bg-danger';
        }
      }
      checkSystemStatus();
      setInterval(checkSystemStatus, 15000); // Poll every 15 seconds

      // Feedback display
      function showFeedback(type, message) {
        const feedback = document.getElementById('feedback');
        feedback.style.display = '';
        feedback.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger') + ' mt-3';
        feedback.innerHTML = message;
      }
      function hideFeedback() {
        const feedback = document.getElementById('feedback');
        feedback.style.display = 'none';
        feedback.className = '';
        feedback.innerHTML = '';
      }

      // Form submission with real backend call
      document.getElementById('streamForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        hideFeedback();
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('submitBtnText');
        const spinner = document.getElementById('submitSpinner');
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'Creating...';

        try {
          const formData = new FormData(this);
          const streamData = {
            title: formData.get('title').trim(),
            description: formData.get('description').trim(),
            protocol: formData.get('protocol'),
            max_viewers: parseInt(formData.get('maxViewers')),
            is_recording: formData.get('isRecording') === 'on',
            adaptive: formData.get('adaptive') === 'on',
            settings: {
              quality: formData.get('quality'),
              bitrate: parseInt(formData.get('bitrate')),
              frameRate: parseInt(formData.get('frameRate'))
            }
          };

          // Validate required fields
          if (!streamData.title) throw new Error('Stream title is required.');

          const response = await fetch('/api/streams', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // Add authentication headers if your API requires it
              // 'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(streamData)
          });

          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to create stream.');
          }
          showFeedback('success', 'Stream created successfully! <br> <b>Stream Key:</b> ' + (result.data?.stream?.stream_key || 'N/A'));
          this.reset();
          // Optionally, redirect or update list after creation
        } catch (error) {
          showFeedback('error', error.message || 'Failed to create stream.');
        } finally {
          btn.disabled = false;
          spinner.classList.add('d-none');
          btnText.textContent = 'Create Streaming Service';
        }
      });
    </script>
</body>
</html>
